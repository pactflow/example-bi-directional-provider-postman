name: Test & Upload to Pactflow

on:
  push:
  workflow_dispatch:
    inputs:
      PACT_CLI_DOCKER_VERSION:
        description:
        required: true
        default: latest

env:
  PACT_BROKER_BASE_URL: https://testdemo.pactflow.io
  PACT_BROKER_TOKEN: ${{ secrets.PACTFLOW_TOKEN_FOR_CI_CD_WORKSHOP }}
  PACT_BROKER_PUBLISH_VERIFICATION_RESULTS: true
  GIT_COMMIT: ${{ github.sha }}
  GITHUB_REF: ${{ github.ref }}
  PACT_CLI_DOCKER_VERSION: ${{ github.event.inputs.PACT_CLI_DOCKER_VERSION }}

jobs:
  createMatrices:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    outputs:
      os: ${{ matrix.os }}

  test:
    needs: [ createMatrices ]
     strategy:
      matrix: ${{ fromJSON(needs.createMatrices.outputs.os) }}
    runs-on: ${{ matrix.os }}
    steps:
      - if: ${{ env.PACT_CLI_DOCKER_VERSION == '' }}
        name: set PACT_CLI_DOCKER_VERSION to latest, if version not present
        run: |
          PACT_CLI_DOCKER_VERSION="latest"
          echo "PACT_CLI_DOCKER_VERSION=${PACT_CLI_DOCKER_VERSION}" >> $GITHUB_ENV 
      - name: PACT_CLI_DOCKER_VERSION is ${{ env.PACT_CLI_DOCKER_VERSION }}
        run: echo $PACT_CLI_DOCKER_VERSION
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2-beta
        with:
          node-version: '12'
      - name: Install
        run: npm i
      - name: Test
        run: GIT_BRANCH=${GITHUB_REF:11} make ci

  # Runs on branches as well, so we know the status of our PRs
  can-i-deploy:
    needs: [ createMatrices,test ]
     strategy:
      matrix: ${{ fromJSON(needs.createMatrices.outputs.os) }}
    steps:
      - if: ${{ env.PACT_CLI_DOCKER_VERSION == '' }}
        name: set PACT_CLI_DOCKER_VERSION to latest, if version not present
        run: |
          PACT_CLI_DOCKER_VERSION="latest"
          echo "PACT_CLI_DOCKER_VERSION=${PACT_CLI_DOCKER_VERSION}" >> $GITHUB_ENV 
      - name: PACT_CLI_DOCKER_VERSION is ${{ env.PACT_CLI_DOCKER_VERSION }}
        run: echo $PACT_CLI_DOCKER_VERSION
      - uses: actions/checkout@v2
      - name: Can I deploy? 
        run: GIT_BRANCH=${GITHUB_REF:11} make can_i_deploy

  # Only deploy from master
  deploy:
    needs: [ createMatrices,can-i-deploy ]
     strategy:
      matrix: ${{ fromJSON(needs.createMatrices.outputs.os) }}
    steps:
      - if: ${{ env.PACT_CLI_DOCKER_VERSION == '' }}
        name: set PACT_CLI_DOCKER_VERSION to latest, if version not present
        run: |
          PACT_CLI_DOCKER_VERSION="latest"
          echo "PACT_CLI_DOCKER_VERSION=${PACT_CLI_DOCKER_VERSION}" >> $GITHUB_ENV 
      - name: PACT_CLI_DOCKER_VERSION is ${{ env.PACT_CLI_DOCKER_VERSION }}
        run: echo $PACT_CLI_DOCKER_VERSION
      - uses: actions/checkout@v2
      - name: Deploy
        run: GIT_BRANCH=${GITHUB_REF:11} make deploy
        if: github.ref == 'refs/heads/master'
