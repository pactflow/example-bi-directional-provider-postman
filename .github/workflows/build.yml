name: Test & Upload to PactFlow

on:
  push:

env:
  PACT_BROKER_BASE_URL: https://testdemo.pactflow.io
  PACT_BROKER_TOKEN: ${{ secrets.PACTFLOW_TOKEN_FOR_CI_CD_WORKSHOP }}
  PACT_BROKER_PUBLISH_VERIFICATION_RESULTS: true
  VERSION: ${{ github.sha }}
  GITHUB_REF: ${{ github.ref }}

jobs:
  use-container:
    runs-on: ubuntu-latest

    container:
      image: pactfoundation/pact-cli:0.54.0-pactcli0.53.0

    steps:
      - uses: actions/checkout@v3
      - run: echo "report" > report.txt
      - name: Publish spec to PactFlow
        run: |
          pactflow publish-provider-contract oas/swagger.yml \
          --provider example-provider \
          --provider-app-version ${VERSION} \
          --branch ${GITHUB_REF:11} \
          --content-type application/yaml \
          --verification-exit-code=0 \
          --verification-results report.txt \
          --verification-results-content-type text/plain \
          --verifier "restassured"
  use-docker-run:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: echo "report" > report.txt
      - name: Publish spec to PactFlow
        run: |
          docker run --rm -v /${PWD}:/${PWD} \
          -w ${PWD} \
          -e PACT_BROKER_BASE_URL \
          -e PACT_BROKER_TOKEN \
          pactfoundation/pact-cli:0.54.0-pactcli0.53.0 \
            pactflow publish-provider-contract oas/swagger.yml \
              --provider example-provider \
              --provider-app-version ${VERSION} \
              --branch ${GITHUB_REF:11} \
              --content-type application/yaml \
              --verification-exit-code=0 \
              --verification-results report.txt \
              --verification-results-content-type text/plain \
              --verifier "restassured"
